<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="dev.tagtag.module.system.mapper.StatisticsMapper">

    <!-- 汇总总数（逻辑未删除统一过滤） -->
    <select id="countUsers" resultType="long">
        SELECT COUNT(1) FROM iam_user WHERE deleted = 0
    </select>
    <select id="countRoles" resultType="long">
        SELECT COUNT(1) FROM iam_role
    </select>
    <select id="countDepts" resultType="long">
        SELECT COUNT(1) FROM iam_dept
    </select>
    <select id="countMessages" resultType="long">
        SELECT COUNT(1) FROM sys_message WHERE deleted = 0
    </select>
    <select id="countUnreadMessages" resultType="long">
        SELECT COUNT(1) FROM sys_message WHERE deleted = 0 AND is_read = 0
    </select>
    <select id="countFiles" resultType="long">
        SELECT COUNT(1) FROM storage_file WHERE deleted = 0
    </select>
    <select id="countDictTypes" resultType="long">
        SELECT COUNT(1) FROM sys_dict_type WHERE deleted = 0
    </select>
    <select id="countDictData" resultType="long">
        SELECT COUNT(1) FROM sys_dict_data WHERE deleted = 0
    </select>

    <!-- 每日计数（返回 day 与 cnt） -->
    <select id="selectUserCountPerDay" resultType="map">
        SELECT DATE(create_time) AS day, COUNT(1) AS cnt
        FROM iam_user
        WHERE deleted = 0 AND create_time &gt;= #{start} AND create_time &lt; DATE_ADD(#{end}, INTERVAL 1 DAY)
        GROUP BY DATE(create_time)
        ORDER BY day
    </select>
    <select id="selectMessageCountPerDay" resultType="map">
        SELECT DATE(create_time) AS day, COUNT(1) AS cnt
        FROM sys_message
        WHERE deleted = 0 AND create_time &gt;= #{start} AND create_time &lt; DATE_ADD(#{end}, INTERVAL 1 DAY)
        GROUP BY DATE(create_time)
        ORDER BY day
    </select>
    <select id="selectFileCountPerDay" resultType="map">
        SELECT DATE(create_time) AS day, COUNT(1) AS cnt
        FROM storage_file
        WHERE deleted = 0 AND create_time &gt;= #{start} AND create_time &lt; DATE_ADD(#{end}, INTERVAL 1 DAY)
        GROUP BY DATE(create_time)
        ORDER BY day
    </select>

    <!-- 分布查询（返回 name 与 value） -->
    <select id="selectFileDistributionByMimeType" resultType="map">
        SELECT COALESCE(mime_type, 'unknown') AS name, COUNT(1) AS value
        FROM storage_file
        WHERE deleted = 0
        GROUP BY COALESCE(mime_type, 'unknown')
        ORDER BY value DESC
    </select>
    <select id="selectFileDistributionByStorageType" resultType="map">
        SELECT COALESCE(storage_type, 'unknown') AS name, COUNT(1) AS value
        FROM storage_file
        WHERE deleted = 0
        GROUP BY COALESCE(storage_type, 'unknown')
        ORDER BY value DESC
    </select>
    <select id="selectFileDistributionByExt" resultType="map">
        SELECT COALESCE(ext, 'unknown') AS name, COUNT(1) AS value
        FROM storage_file
        WHERE deleted = 0
        GROUP BY COALESCE(ext, 'unknown')
        ORDER BY value DESC
    </select>
    <select id="selectMessageDistributionByStatus" resultType="map">
        SELECT CASE WHEN is_read = 1 THEN 'read' ELSE 'unread' END AS name, COUNT(1) AS value
        FROM sys_message
        WHERE deleted = 0
        GROUP BY CASE WHEN is_read = 1 THEN 'read' ELSE 'unread' END
        ORDER BY value DESC
    </select>
    <select id="selectMessageDistributionByType" resultType="map">
        SELECT COALESCE(type, 'unknown') AS name, COUNT(1) AS value
        FROM sys_message
        WHERE deleted = 0
        GROUP BY COALESCE(type, 'unknown')
        ORDER BY value DESC
    </select>

</mapper>
