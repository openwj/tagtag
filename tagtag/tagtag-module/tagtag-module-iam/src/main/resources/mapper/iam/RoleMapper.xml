<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="dev.tagtag.module.iam.mapper.RoleMapper">

    <!-- 角色分页查询 -->
    <select id="selectPage" resultType="dev.tagtag.module.iam.entity.Role">
        SELECT
            id,
            code,
            name,
            status,
            role_type AS roleType,
            sort,
            remark,
            create_time AS createTime,
            update_time AS updateTime,
            create_by AS createBy,
            update_by AS updateBy
        FROM iam_role
        <where>
            <if test="q != null">
                <if test="q.code != null and q.code != ''">
                    AND code LIKE CONCAT('%', #{q.code}, '%')
                </if>
                <if test="q.name != null and q.name != ''">
                    AND name LIKE CONCAT('%', #{q.name}, '%')
                </if>
                <if test="q.status != null">
                    AND status = #{q.status.code}
                </if>
            </if>
        </where>

        <if test="orderBySql != null and orderBySql != ''">
            ${orderBySql}
        </if>
        <if test="orderBySql == null or orderBySql == ''">
            ORDER BY id ASC
        </if>
    </select>

    <!-- 查询角色的权限ID列表 -->
    <select id="selectPermissionIdsByRoleId" resultType="long">
        SELECT rm.menu_id
        FROM iam_role_menu rm
        JOIN iam_menu m ON rm.menu_id = m.id
        WHERE rm.role_id = #{roleId}
          AND m.menu_type = 2
    </select>

    <!-- 查询角色分配的全部菜单ID（目录/菜单/按钮） -->
    <select id="selectMenuIdsByRoleId" resultType="long">
        SELECT rm.menu_id
        FROM iam_role_menu rm
        WHERE rm.role_id = #{roleId}
    </select>

    <!-- 删除角色的所有权限关联 -->
    <delete id="deleteRolePermissions">
        DELETE FROM iam_role_menu WHERE role_id = #{roleId}
    </delete>

    <!-- 批量插入角色权限关联 -->
    <insert id="insertRolePermissions">
        INSERT INTO iam_role_menu (role_id, menu_id)
        VALUES
        <foreach collection="permissionIds" item="pid" separator=",">
            (#{roleId}, #{pid})
        </foreach>
    </insert>

    <!-- 按角色ID集合批量查询按钮型菜单的权限编码（menu_code） -->
    <select id="selectPermissionCodesByRoleIds" resultType="string">
        SELECT DISTINCT m.menu_code
        FROM iam_role_menu rm
        JOIN iam_menu m ON rm.menu_id = m.id
        WHERE rm.role_id IN
        <foreach collection="roleIds" item="rid" open="(" separator="," close=")">
            #{rid}
        </foreach>
          AND m.menu_type = 2
          AND m.deleted = 0
    </select>

    <!-- 根据角色ID查询按钮型菜单实体列表（JOIN 查询） -->
    <select id="selectMenusByRoleId" resultType="dev.tagtag.module.iam.entity.Menu">
        SELECT m.id,
               m.parent_id    AS parentId,
               m.menu_name    AS menuName,
               m.menu_code    AS menuCode,
               m.path,
               m.component,
               m.icon,
               m.sort,
               m.status,
               m.menu_type    AS menuType,
               m.is_hidden    AS isHidden,
               m.is_external  AS isExternal,
               m.external_url AS externalUrl,
               m.remark,
               m.is_keepalive AS isKeepalive,
               m.create_time  AS createTime,
               m.create_by    AS createBy,
               m.update_time  AS updateTime,
               m.update_by    AS updateBy,
               m.deleted
        FROM iam_role_menu rm
        JOIN iam_menu m ON rm.menu_id = m.id
        WHERE rm.role_id = #{roleId}
          AND m.menu_type = 2
    </select>

</mapper>
