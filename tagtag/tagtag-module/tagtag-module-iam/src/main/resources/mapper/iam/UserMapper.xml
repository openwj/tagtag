<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="dev.tagtag.module.iam.mapper.UserMapper">

    <!--
      用户分页查询（MyBatis Plus 分页拦截器生效，参数名需为 page）
      - q: UserQueryDTO 查询条件
      - orderList: List<SortField> 排序字段（字段名将按白名单映射到列）
    -->
    <select id="selectPage" resultType="dev.tagtag.module.iam.entity.User">
        SELECT
            id,
            username,
            nickname,
            email,
            mobile,
            gender,
            dept_id AS deptId,
            status,
            create_time AS createTime,
            update_time AS updateTime,
            create_by AS createBy,
            update_by AS updateBy
        FROM iam_user
        <where>
            <if test="q != null">
                <if test="q.username != null and q.username != ''">
                    AND username LIKE CONCAT('%', #{q.username}, '%')
                </if>
                <if test="q.nickname != null and q.nickname != ''">
                    AND nickname LIKE CONCAT('%', #{q.nickname}, '%')
                </if>
                <if test="q.status != null">
                    AND status = #{q.status.code}
                </if>
                <if test="q.gender != null">
                    AND gender = #{q.gender.code}
                </if>
                <if test="q.email != null and q.email != ''">
                    AND email LIKE CONCAT('%', #{q.email}, '%')
                </if>
                <if test="q.mobile != null and q.mobile != ''">
                    AND mobile LIKE CONCAT('%', #{q.mobile}, '%')
                </if>
                <if test="q.createTimeRange != null and q.createTimeRange.start != null">
                    AND create_time &gt;= #{q.createTimeRange.start}
                </if>
                <if test="q.createTimeRange != null and q.createTimeRange.end != null">
                    AND create_time &lt;= #{q.createTimeRange.end}
                </if>
            </if>
        </where>

        <if test="orderBySql != null and orderBySql != ''">
            ${orderBySql}
        </if>
        <if test="orderBySql == null or orderBySql == ''">
            ORDER BY id ASC
        </if>
    </select>


    <!-- 查询用户的角色ID列表 -->
    <select id="selectRoleIdsByUserId" resultType="long">
        SELECT role_id
        FROM iam_user_role
        WHERE user_id = #{userId}
    </select>

    <!-- 删除用户的所有角色关联 -->
    <delete id="deleteUserRoles">
        DELETE FROM iam_user_role WHERE user_id = #{userId}
    </delete>

    <!-- 批量插入用户角色关联 -->
    <insert id="insertUserRoles">
        INSERT INTO iam_user_role (user_id, role_id)
        VALUES
        <foreach collection="roleIds" item="rid" separator=",">
            (#{userId}, #{rid})
        </foreach>
    </insert>

</mapper>
