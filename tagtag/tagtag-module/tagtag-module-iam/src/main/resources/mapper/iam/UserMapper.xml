<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="dev.tagtag.module.iam.mapper.UserMapper">

    <!--
      用户分页查询（MyBatis Plus 分页拦截器生效，参数名需为 page）
      - q: UserQueryDTO 查询条件
      - orderList: List<SortField> 排序字段（字段名将按白名单映射到列）
    -->
    <select id="selectPage" resultType="dev.tagtag.module.iam.entity.vo.UserVO">
        SELECT
            u.id,
            u.username,
            u.nickname,
            u.email,
            u.phone,
            u.gender,
            u.dept_id AS deptId,
            u.status,
            u.is_admin AS isAdmin,
            u.avatar,
            u.remark,
            u.employee_no AS employeeNo,
            u.position AS position,
            u.birthday,
            u.entry_date AS entryDate,
            u.last_login_time AS lastLoginTime,
            u.last_login_ip AS lastLoginIp,
            u.password_updated_at AS passwordUpdatedAt,
            u.create_time AS createTime,
            u.update_time AS updateTime,
            u.create_by AS createBy,
            u.update_by AS updateBy,
            d.name AS deptName
        FROM iam_user u
        LEFT JOIN iam_dept d ON d.id = u.dept_id
        <where>
            <if test="q != null">
                <if test="q.username != null and q.username != ''">
                    AND u.username LIKE CONCAT('%', #{q.username}, '%')
                </if>
                <if test="q.nickname != null and q.nickname != ''">
                    AND u.nickname LIKE CONCAT('%', #{q.nickname}, '%')
                </if>
                <if test="q.status != null">
                    AND u.status = #{q.status.code}
                </if>
                <if test="q.gender != null">
                    AND u.gender = #{q.gender.code}
                </if>
                <if test="q.email != null and q.email != ''">
                    AND u.email LIKE CONCAT('%', #{q.email}, '%')
                </if>
                <if test="q.phone != null and q.phone != ''">
                    AND u.phone LIKE CONCAT('%', #{q.phone}, '%')
                </if>
                <if test="q.deptId != null">
                    AND u.dept_id = #{q.deptId}
                </if>
                <if test="q.employeeNo != null and q.employeeNo != ''">
                    AND u.employee_no LIKE CONCAT('%', #{q.employeeNo}, '%')
                </if>
                <if test="q.entryDateRange != null and q.entryDateRange.start != null">
                    AND u.entry_date &gt;= #{q.entryDateRange.start}
                </if>
                <if test="q.entryDateRange != null and q.entryDateRange.end != null">
                    AND u.entry_date &lt;= #{q.entryDateRange.end}
                </if>
                <if test="q.createTimeRange != null and q.createTimeRange.start != null">
                    AND u.create_time &gt;= #{q.createTimeRange.start}
                </if>
                <if test="q.createTimeRange != null and q.createTimeRange.end != null">
                    AND u.create_time &lt;= #{q.createTimeRange.end}
                </if>
            </if>
        </where>

        <if test="orderBySql != null and orderBySql != ''">
            ${orderBySql}
        </if>
        <if test="orderBySql == null or orderBySql == ''">
            ORDER BY u.id ASC
        </if>
    </select>


    <!-- 查询用户的角色ID列表 -->
    <select id="selectRoleIdsByUserId" resultType="long">
        SELECT role_id
        FROM iam_user_role
        WHERE user_id = #{userId}
    </select>

    <!-- 删除用户的所有角色关联 -->
    <delete id="deleteUserRoles">
        DELETE FROM iam_user_role WHERE user_id = #{userId}
    </delete>

    <!-- 批量插入用户角色关联 -->
    <insert id="insertUserRoles">
        INSERT INTO iam_user_role (user_id, role_id)
        VALUES
        <foreach collection="roleIds" item="rid" separator=",">
            (#{userId}, #{rid})
        </foreach>
    </insert>

</mapper>
