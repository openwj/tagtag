## 目标
- 提升可读性与可维护性，去除零散判断与手工集合处理。
- 保持既有行为：统一错误文案“凭证无效”、返回码 400/401 不变；令牌中继续携带 ver 并受版本校验。

## 改动要点
- 提取清晰的私有辅助方法，按职责分层：
  - `normalize(String s)`：统一裁剪与空值处理。
  - `loadUserOrFail(String uname)`：按用户名加载用户，不存在时抛 `UNAUTHORIZED`。
  - `normalizeStoredHash(String stored)`：兼容去掉`{bcrypt}`前缀；若为空直接判定无效。
  - `verifyPassword(String rawPwd, String storedHash)`：仅支持 BCrypt；非 BCrypt 一律判为无效，避免明文分支。
  - `resolvePermissions(List<Long> roleIds)`：用 Stream 扁平化角色菜单，去重、过滤空，收集 `Set<String>`。
  - `buildClaims(UserDTO full, List<Long> roleIds, Set<String> perms, long ver)`：统一构造只读 `Map<String,Object>`；生成访问/刷新令牌各自拷贝更新 `typ`。
  - 所有方法添加函数级注释。
- 使用 `Objects.requireNonNullElse`、`Collections.emptyList()`、Stream API，替换手工 for 循环与空判断。
- 明确策略：仅允许 BCrypt 存储；发现非 BCrypt 或空凭证，统一抛 `UNAUTHORIZED`（“凭证无效”）。

## 实施步骤
1. 在 `AuthServiceImpl.login` 中：
  - 规范化输入 `uname/pwd`，空则抛 `BAD_REQUEST`。
  - `loadUserOrFail` 获取 `full`，同时校验 `password` 不能为空。
  - `normalizeStoredHash` + `verifyPassword` 校验口令，不通过抛 `UNAUTHORIZED`。
  - `resolvePermissions(roleIds)` 收集权限。
  - 用 `buildClaims` 构造 claims，并发放访问/刷新令牌；封装 `issueTokens` 返回 `TokenDTO`。
2. 在 `AuthServiceImpl.refresh` 中：
  - 保留现有校验，继续校验令牌 `ver` 与服务端版本相等（版本服务不变）。
3. 保持 `BusinessException` 与返回结构不变；不改动控制器与全局异常处理逻辑。
4. 编译与运行验证，确保登录、刷新、注销逻辑通过。

## 交付
- 重构后的 `AuthServiceImpl`，方法结构清晰、含函数级注释；行为一致。
- 构建通过并完成基本接口自测（登录成功、失败分支、注销后旧令牌 401）。

## 备注
- 若未来需要兼容明文口令或多算法，可在 `verifyPassword` 中引入策略枚举并集中管理；当前按照安全最佳实践，仅支持 BCrypt。