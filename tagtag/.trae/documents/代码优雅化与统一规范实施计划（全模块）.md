## 总原则
- 优先使用框架/标准库内置能力（Spring Boot 3、Spring Security、Bean Validation、MyBatis-Plus）。
- 移除重复代码，抽取通用封装，统一风格与命名。
- 保持功能等价或更优，所有新增/修改方法添加函数级注释。

## 横向规范（全局适用）
- Import 规范：移除全限定类名调用，统一通过 import 引用（已在 SecurityConfig、TokenVersionFilter 处理）。
- 常量与配置：统一集中在 `kernel.constant`（消息/Key/Claim 名称），配置采用 `@ConfigurationProperties` 注入，替代零散 `@Value`。
- 校验与异常：Controller 使用 `@Valid` + `jakarta.validation.*`，Service 层只保留必要的防御性校验。统一抛 `BusinessException`，ErrorCode 与 HTTP 状态一致。字段错误由 `GlobalExceptionHandler` 聚合返回 422。
- 日志：统一使用 `@Slf4j`，只记录上下文与关键信息，不输出敏感数据（如口令/完整令牌）。
- 集合与流：统一使用 `Objects.requireNonNullElse`、`Collections.empty*`、Stream API、`Set` 去重，避免手工循环。

## 安全模块（framework + auth）
- 密码编码器：使用 `DelegatingPasswordEncoder`，删除历史前缀剥离/手工算法分支，统一 `matches`。
- 令牌版本：保持 `ver` 方案，`TokenVersionFilter` 使用 import 与工具方法，避免全限定引用。
- Claims 常量化：提取 `uid/uname/roles/perms/ver/typ` 为常量，集中在 `kernel.constant.SecurityClaims`，统一读写，减少魔法字符串。
- Dev 端点隔离：辅助端点置于 `@Profile("dev")` 控制器（已完成）。

## IAM 模块
- 权限聚合接口：已新增 `RoleApi.listMenuCodesByRoleIds(List<Long>)`，`RoleServiceImpl` 使用一次 SQL 去重返回 `Set<String>`。
- 后续优化：为聚合接口增加缓存（`@Cacheable`），在角色权限变更时失效，进一步降低数据库压力。

## Auth 模块
- 权限解析：`PermissionResolver` 改为一次调用 IAM 聚合 API（已完成）。
- Service 简化：`AuthServiceImpl` 使用 `Strings.normalize`、`DelegatingPasswordEncoder.matches`，保持统一业务文案常量。
- TTL 配置化：`security.jwt.access-ttl-seconds`、`refresh-ttl-seconds` 已外部化，使用注入属性替代硬编码。

## MyBatis-Plus 与持久层
- XML 精简：能用 MyBatis-Plus Wrapper 则尽量替换 XML/手写 SQL（分页、条件、排序），保留复杂查询在 XML。
- 自动填充：在 `MybatisPlusConfig` 统一注册 `MetaObjectHandler`（若已存在，确认字段映射统一），减少重复的时间/人字段赋值。
- Mapper 接口：统一方法命名与返回类型，IN 查询统一使用 `@Param List`，结果集合优先 `Set<String>` 去重。

## 统一封装
- 工具类：
  - `Strings`、`Numbers` 保留，优先使用框架内置时移除自定义方案（如类型转换可注入 `ConversionService`，或直接在生成 claims 时保证类型正确）。
  - 新增 `SecurityClaims` 常量类，统一 claim 名称与用途。
- 令牌工厂与权限解析已抽取（`TokenFactory`、`PermissionResolver`），继续保持业务边界清晰。

## 测试与验证
- 补充 MockMvc 集成测试：
  - 登录成功/失败用例（空参、用户不存在、密码错误 → 400/401）；
  - 刷新令牌版本校验；
  - 注销后旧令牌 401；
  - 权限聚合接口行为（roleIds → 权限 codes）。
- Dev 环境运行验证（已具备 clean+migrate），检查功能无回归。

## 实施步骤（批次）
1. 安全层整理：DelegatingPasswordEncoder 引用规范、SecurityClaims 常量化（auth/framework）。
2. IAM 聚合与缓存：在现有接口基础上加缓存与失效策略（可选）。
3. 持久层精简：能用 Wrapper 的分页与条件查询迁移，统一 Mapper 命名与返回类型。
4. Controller/Service 统一：校验与异常抛出规范、移除重复校验、统一文案与日志。
5. 测试与编译：增补测试用例，CI 构建与本地运行验证。

## 交付
- 提供改动 PR（分模块分批），所有方法附带函数级注释，说明职责与参数。
- 构建与运行验证报告，列出主要路径的行为等价性与性能（调用次数）改进说明。