---
title: Storage Module
description: File storage module documentation, detailing storage implementation, supported storage modes, and core functionalities.
---

The **Storage** module is responsible for file upload, download, preview, and management in the system. It supports multiple storage modes and provides a unified file operation interface.

## 1. Storage Overview

The storage module adopts an abstract design, supporting multiple storage modes that can be flexibly switched through configuration without modifying business code.

### 1.1 Design Philosophy

- **Abstract Unified Interface**: Define a unified storage interface to shield implementation differences between different storage modes
- **Modular Design**: Different storage modes are treated as independent modules for easy extension and maintenance
- **Configuration Driven**: Dynamically switch storage modes through configuration files
- **High Performance**: Support file caching and asynchronous operations
- **High Reliability**: Support file backup and recovery

### 1.2 Supported Storage Modes

| Storage Mode | Description | Application Scenario |
|--------------|-------------|---------------------|
| Local Storage | Files are saved to the server's local disk | Development environment, small applications |
| Object Storage | Use cloud vendor object storage services (such as Alibaba Cloud OSS, Tencent Cloud COS, MinIO) | Production environment, high-concurrency applications |

## 2. Data Model

### 2.1 File Information (FileInfo)

**Properties**:
- File ID (file_id): Unique identifier, generated using UUID
- File Name (file_name): Original file name
- File Size (file_size): File size in bytes
- Content Type (content_type): MIME type
- File Path (file_path): Storage path
- Access URL (url): File access address
- Storage Type (storage_type): Storage mode, such as `local` or `minio`
- Uploader ID (uploader_id): ID of the uploader
- Upload Time (upload_time): Upload timestamp
- Status (status): File status, such as normal or deleted

### 2.2 Storage Configuration (StorageConfig)

**Properties**:
- Storage Type (storage_type): Type of storage mode
- Config (config): Configuration parameters for the specific storage mode, in JSON format
- Status: Enabled/disabled
- Description: Configuration description

## 3. Core Features

### 3.1 File Upload

Support multiple file upload methods:
- Single file upload
- Multiple file upload
- Chunked upload
- Resumable upload

**Upload Process**:
1. Receive file upload request
2. Verify file type and size
3. Generate unique file name
4. Select upload strategy based on storage mode
5. Execute file upload
6. Record file information to database
7. Return upload result (file ID, access URL, etc.)

### 3.2 File Download

Support file download functionality:
- Direct download
- Preview download
- Batch download

**Download Process**:
1. Receive file download request
2. Verify file existence and access permissions
3. Select download strategy based on storage mode
4. Execute file download
5. Return file stream to client

### 3.3 File Preview

Support online preview of common file types:
- Image preview (JPG, PNG, GIF, etc.)
- Document preview (PDF, Word, Excel, PPT, etc.)
- Audio and video preview

**Preview Process**:
1. Receive file preview request
2. Verify file existence and access permissions
3. Check if file type supports preview
4. Select preview method based on file type
5. Return preview result

### 3.4 File Management

Provide complete file management functionality:
- File list query
- File detail query
- File deletion
- File renaming
- File moving
- File copying

### 3.5 Storage Configuration Management

Support dynamic management of storage configurations:
- Add storage configuration
- Modify storage configuration
- Delete storage configuration
- Switch default storage configuration

## 4. Implementation Details

### 4.1 Abstract Storage Interface

Define a unified storage interface that all storage modes implement:

```java
public interface StorageService {
    
    /**
     * Upload file
     * @param file Uploaded file
     * @param prefix File prefix
     * @return Storage result
     */
    StorageResult upload(MultipartFile file, String prefix);
    
    /**
     * Download file
     * @param fileId File ID
     * @param response Response object
     */
    void download(String fileId, HttpServletResponse response);
    
    /**
     * Preview file
     * @param fileId File ID
     * @param response Response object
     */
    void preview(String fileId, HttpServletResponse response);
    
    /**
     * Delete file
     * @param fileId File ID
     */
    void delete(String fileId);
    
    /**
     * Get file information
     * @param fileId File ID
     * @return File information
     */
    FileInfo getFileInfo(String fileId);
}
```

### 4.2 Storage Mode Implementation

#### 4.2.1 Local Storage Implementation

```java
@Service
@ConditionalOnProperty(name = "storage.type", havingValue = "local")
public class LocalStorageServiceImpl implements StorageService {
    
    @Value("${storage.local.base-path}")
    private String basePath;
    
    @Value("${storage.local.domain}")
    private String domain;
    
    @Override
    public StorageResult upload(MultipartFile file, String prefix) {
        // Local storage upload implementation
        // 1. Generate unique file name
        // 2. Create storage directory
        // 3. Save file to local disk
        // 4. Record file information
        // 5. Return storage result
    }
    
    // Other method implementations...
}
```

#### 4.2.2 Object Storage Implementation

```java
@Service
@ConditionalOnProperty(name = "storage.type", havingValue = "minio")
public class MinioStorageServiceImpl implements StorageService {
    
    @Autowired
    private MinioClient minioClient;
    
    @Value("${storage.minio.bucket-name}")
    private String bucketName;
    
    @Value("${storage.minio.domain}")
    private String domain;
    
    @Override
    public StorageResult upload(MultipartFile file, String prefix) {
        // MinIO upload implementation
        // 1. Generate unique file name
        // 2. Upload file to MinIO
        // 3. Record file information
        // 4. Return storage result
    }
    
    // Other method implementations...
}
```

### 4.3 Configuration Examples

#### 4.3.1 Local Storage Configuration

```yaml
# Local storage configuration
storage:
  type: local
  local:
    base-path: uploads       # File storage root directory
    domain: http://localhost:8080  # File access domain
    max-size: 104857600      # Maximum file size (100MB)
    allowed-types:           # Allowed upload file types
      - image/*
      - application/pdf
      - application/msword
```

#### 4.3.2 MinIO Configuration

```yaml
# MinIO configuration
storage:
  type: minio
  minio:
    endpoint: http://minio:9000  # MinIO service address
    access-key: minioadmin        # Access key
    secret-key: minioadmin        # Secret key
    bucket-name: tagtag           # Bucket name
    domain: http://minio:9000     # File access domain
    max-size: 104857600           # Maximum file size (100MB)
    allowed-types:                # Allowed upload file types
      - image/*
      - application/pdf
```

## 5. Core Code Structure

### 5.1 Backend Code Structure

```
tagtag-module-storage
└── src
    └── main
        ├── java
        │   └── dev
        │       └── tagtag
        │           └── module
        │               └── storage
        │                   ├── config
        │                   │   ├── LocalStorageConfig.java
        │                   │   ├── MinioStorageConfig.java
        │                   │   └── StorageAutoConfiguration.java
        │                   ├── controller
        │                   │   └── StorageController.java
        │                   ├── entity
        │                   │   ├── FileInfoEntity.java
        │                   │   └── StorageConfigEntity.java
        │                   ├── mapper
        │                   │   ├── FileInfoMapper.java
        │                   │   └── StorageConfigMapper.java
        │                   ├── service
        │                   │   ├── StorageService.java
        │                   │   ├── impl
        │                   │   │   ├── LocalStorageServiceImpl.java
        │                   │   │   └── MinioStorageServiceImpl.java
        │                   │   └── FileInfoService.java
        │                   └── util
        │                       ├── FileUtil.java
        │                       └── StorageUtil.java
        └── resources
            ├── db
            │   ├── schema.sql
            │   └── data
            │       └── 01_storage_config.sql
            └── mapper
                └── storage
                    ├── FileInfoMapper.xml
                    └── StorageConfigMapper.xml
```

### 5.2 Frontend Code Structure

```
tagtag-ui/apps/tagtag/src/views/modules/storage
├── file
│   ├── data.ts
│   └── index.vue
└── config
    ├── data.ts
    └── index.vue
```

## 6. Frontend Implementation

Frontend-related code is located in `tagtag-ui/apps/tagtag/src/views/modules/storage`.

| Function | Page Path | Description |
| :--- | :--- | :--- |
| File Management | `/storage/file` | File list, upload, download, preview, delete |
| Storage Configuration | `/storage/config` | Storage mode configuration, switching |

### 6.1 File Upload Component

```vue
<template>
  <div class="file-uploader">
    <a-upload
      :action="uploadUrl"
      :headers="headers"
      :before-upload="beforeUpload"
      :on-success="handleSuccess"
      :on-error="handleError"
    >
      <a-button>
        <UploadOutlined /> Select File
      </a-button>
    </a-upload>
  </div>
</template>

<script setup lang="ts">
import { UploadOutlined } from '@ant-design/icons-vue';
import { message } from 'ant-design-vue';
import { useToken } from '@/hooks/useToken';

const emit = defineEmits<{
  (e: 'success', file: any): void;
  (e: 'error', error: any): void;
}>();

const { token } = useToken();
const uploadUrl = import.meta.env.VITE_API_BASE_URL + '/storage/upload';

const headers = {
  'Authorization': `Bearer ${token.value}`
};

const beforeUpload = (file: File) => {
  // Verify file type and size
  const isImage = file.type.startsWith('image/');
  const isLt10M = file.size / 1024 / 1024 < 10;
  
  if (!isImage) {
    message.error('Only image files are allowed!');
    return false;
  }
  if (!isLt10M) {
    message.error('File size cannot exceed 10MB!');
    return false;
  }
  return true;
};

const handleSuccess = (response: any) => {
  if (response.success) {
    message.success('File upload successful!');
    emit('success', response.data);
  } else {
    message.error('File upload failed: ' + response.message);
    emit('error', response);
  }
};

const handleError = (error: any) => {
  message.error('File upload failed: ' + error.message);
  emit('error', error);
};
</script>
```

## 7. API Reference

| Method | Endpoint | Description |
| :--- | :--- | :--- |
| POST | `/storage/upload` | Upload file |
| GET | `/storage/download/{fileId}` | Download file |
| GET | `/storage/preview/{fileId}` | Preview file |
| DELETE | `/storage/{fileId}` | Delete file |
| GET | `/storage/list` | Get file list |
| GET | `/storage/{fileId}` | Get file details |
| GET | `/storage/config` | Get storage configuration |
| POST | `/storage/config` | Add storage configuration |
| PUT | `/storage/config` | Update storage configuration |
| DELETE | `/storage/config/{configId}` | Delete storage configuration |
| PUT | `/storage/config/set-default/{configId}` | Set default storage configuration |

## 8. Best Practices

### 8.1 File Naming

- Use UUID to generate unique file names to avoid filename conflicts
- Keep the original file name and store it in the database
- Use directory hierarchical storage to avoid too many files in a single directory

### 8.2 File Size Limitation

- Set reasonable file size limits based on business requirements
- Verify file size both on frontend and backend
- Use chunked upload and resumable upload for large files

### 8.3 File Type Verification

- Limit allowed file types
- Verify file types both on frontend and backend
- Special handling for executable files and script files

### 8.4 Security Measures

- Perform virus scanning on uploaded files
- Set reasonable file access permissions
- Use encrypted storage for sensitive files
- Regularly back up important files

### 8.5 Performance Optimization

- Use CDN to accelerate file access
- Cache hot files
- Asynchronously process file uploads and downloads
- Regularly clean up expired files

## 9. Extension Suggestions

### 9.1 Support More Storage Modes

- Add support for more cloud vendor object storage
- Support distributed file systems (such as FastDFS, GlusterFS)

### 9.2 Enhance File Management Functions

- Support file version management
- Support file sharing functionality
- Support file comments and tags
- Support file search functionality

### 9.3 Enhance Security Functions

- Support file encryption storage
- Support file access logs
- Support file access permission control
- Support file watermarking functionality

### 9.4 Enhance Performance Functions

- Support file compression and transcoding
- Support intelligent caching strategies
- Support file preloading
- Support file chunked downloading

## 10. Summary

The storage module is one of the core modules of the Tagtag system, responsible for file upload, download, preview, and management in the system.

Through the storage module, the system can flexibly support multiple storage modes, provide a unified file operation interface, and meet the needs of different scenarios. The design and implementation of the storage module follow the principles of modularity and extensibility, facilitating subsequent functional expansion and customized development.

The core functions of the storage module include file upload, download, preview, and management, supporting both local storage and object storage modes. Through reasonable configuration and best practices, the system's performance, reliability, and security can be improved.